name: Validate branch and commits

on:
  pull_request:
    branches:
      - develop
      - main

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 3

      - name: Detect branch name
        id: detect
        run: |
          if [ -n "${GITHUB_HEAD_REF}" ]; then
            echo "branch=${GITHUB_HEAD_REF}" >> $GITHUB_OUTPUT
          else
            echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi

      - name: Validate branch only for feature/fix/docs/test
        run: |
          BRANCH="${{ steps.detect.outputs.branch }}"
          echo "Validando rama: $BRANCH"

          if [[ "$BRANCH" == "develop" || "$BRANCH" == "main" ]]; then
            echo "Rama es 'develop' o 'main'. No se valida."
            exit 0
          fi

          if [[ ! "$BRANCH" =~ ^(feature|fix|docs|test)\/[0-9]+-[a-z0-9-]+$ ]]; then
            echo "Nombre de rama inválido: $BRANCH"
            echo "Debe cumplir: (feature|fix|docs|test)/<id>-descripcion"
            exit 1
          fi

          echo "Nombre de rama válido."

      - name: Skip commit validation for develop → main
        id: skip_commits
        run: |
          BASE="${{ github.base_ref }}"
          HEAD="${{ github.head_ref }}"

          if [[ "$BASE" == "main" && "$HEAD" == "develop" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "PR de develop → main: no se validan commits."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate the last 2 commit messages
        if: ${{ github.event_name == 'pull_request' && steps.skip_commits.outputs.skip == 'false' }}
        run: |
          echo "Validando solo los últimos 2 commits..."

          # Obtener los últimos 2 mensajes de commit del HEAD del PR
          COMMITS=$(git log -2 --pretty=format:"%s")

          echo "Commits encontrados:"
          echo "$COMMITS"

          INVALID=0

          while IFS= read -r msg; do
            echo "Revisando: '$msg'"

            # Permitir merge commits
            if echo "$msg" | grep -qi "merge"; then
              echo " - Merge commit permitido."
              continue
            fi

            # Validar formato AB#123 Mensaje
            if ! echo "$msg" | grep -Eq "^AB#[0-9]+ "; then
              echo "Commit inválido: '$msg'"
              INVALID=1
            fi
          done <<< "$COMMITS"

          if [ $INVALID -eq 1 ]; then
            echo "Error: Hay commits inválidos."
            exit 1
          fi

          echo "Todos los commits cumplen el formato."

  deploy_to_acr:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Azure Login with Credentials
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build & Push Docker Image
        run: |
          ACR="${{ secrets.ACR_NAME }}.azurecr.io"
          IMAGE_NAME="synapse-frontend"
          TAG="${GITHUB_SHA::7}"

          docker build -t $ACR/$IMAGE_NAME:$TAG .
          docker push $ACR/$IMAGE_NAME:$TAG

          # Latest solo en main
          docker tag $ACR/$IMAGE_NAME:$TAG $ACR/$IMAGE_NAME:latest
          docker push $ACR/$IMAGE_NAME:latest

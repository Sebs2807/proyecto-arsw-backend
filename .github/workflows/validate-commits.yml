name: Validate branch and commits

on:
  pull_request:
    branches:
      - develop
      - main

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect branch name
        id: detect
        run: |
          # Si es pull_request, usar GITHUB_HEAD_REF
          if [ -n "${GITHUB_HEAD_REF}" ]; then
            echo "branch=${GITHUB_HEAD_REF}" >> $GITHUB_OUTPUT
          else
            # Si no, usar referencia directa
            echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi

      - name: Validate branch only for feature/fix/docs/test
        run: |
          BRANCH="${{ steps.detect.outputs.branch }}"
          echo "Validando rama: $BRANCH"

          # Permitir develop y main sin validación
          if [[ "$BRANCH" == "develop" || "$BRANCH" == "main" ]]; then
            echo "Rama es 'develop' o 'main'. No se valida."
            exit 0
          fi

          # Validar patrones permitidos
          if [[ ! "$BRANCH" =~ ^(feature|fix|docs|test)\/[0-9]+-[a-z0-9-]+$ ]]; then
            echo "Nombre de rama inválido: $BRANCH"
            echo "Debe cumplir: (feature|fix|docs|test)/<id>-descripcion"
            exit 1
          fi

          echo "✔ Nombre de rama válido."

      - name: Skip commit validation for develop → main
        id: skip_commits
        run: |
          BASE="${{ github.base_ref }}"
          HEAD="${{ github.head_ref }}"

          if [[ "$BASE" == "main" && "$HEAD" == "develop" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "PR de develop → main: no se validan commits."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate commit messages (PR only)
        if: ${{ github.event_name == 'pull_request' && steps.skip_commits.outputs.skip == 'false' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Validando commits del PR..."

          # Usar GitHub CLI
          PR_COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].messageHeadline')

          if [ -z "$PR_COMMITS" ]; then
            echo "⚠ No hay commits en el PR."
            exit 0
          fi

          echo "Commits encontrados:"
          echo "$PR_COMMITS"

          while IFS= read -r line; do
            if [[ "$line" =~ ^Merge\ .* ]]; then
              echo "Merge commit permitido: '$line'"
              continue
            fi
            if [[ ! "$line" =~ ^AB#[0-9]+\ .* ]]; then
              echo "Commit inválido: '$line'"
              echo "Debe iniciar con: AB#<id> Mensaje"
              exit 1
            fi
          done <<< "$PR_COMMITS"

          echo "Todos los commits cumplen el formato."

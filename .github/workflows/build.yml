deploy_to_acr:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Azure Login with Credentials
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build & Push Docker Image
        run: |
          ACR_HOST="${{ secrets.ACR_NAME }}.azurecr.io"
          IMAGE_NAME="synapse-backend"
          TAG="${GITHUB_SHA::7}"

          docker build -t $ACR_HOST/$IMAGE_NAME:$TAG .
          docker push $ACR_HOST/$IMAGE_NAME:$TAG

          docker tag $ACR_HOST/$IMAGE_NAME:$TAG $ACR_HOST/$IMAGE_NAME:latest
          docker push $ACR_HOST/$IMAGE_NAME:latest

      - name: Run Database Migrations (via ACI in VNet)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            ACR_HOST="${{ secrets.ACR_NAME }}.azurecr.io"
            IMAGE_TAG="$ACR_HOST/synapse-backend:${{ github.sha::7 }}"
            RG_NAME="sd-synapse-4d-rg"
            MIG_JOB_NAME="migrator-${{ github.sha::7 }}"
            
            VNET_NAME="${{ secrets.RESOURCE_PREFIX }}-vnet" 
            SUBNET_NAME="subnet-aca" 

            echo "Starting ACI job $MIG_JOB_NAME in VNet to run migrations..."
            az container create \
              --resource-group $RG_NAME \
              --name $MIG_JOB_NAME \
              --image $IMAGE_TAG \
              --registry-login-server $ACR_HOST \
              --registry-username ${{ secrets.ACR_USERNAME }} \
              --registry-password ${{ secrets.ACR_PASSWORD }} \
              --vnet $VNET_NAME \
              --subnet $SUBNET_NAME \
              --restart-policy Never \
              --command-line "npm run typeorm migration:run -- -d dist/database/data-source.js" \
              --environment-variables \
                NODE_ENV=production \
                DB_HOST=${{ secrets.DB_HOST }} \
                DB_PORT=${{ secrets.DB_PORT }} \
                DB_USER=${{ secrets.DB_USER }} \
                DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
                DB_NAME=${{ secrets.DB_NAME }}
            
            echo "Waiting for migration job to complete..."
            az container wait --name $MIG_JOB_NAME --resource-group $RG_NAME --timeout 600

            EXIT_CODE=$(az container show \
              --name $MIG_JOB_NAME \
              --resource-group $RG_NAME \
              --query "containers[0].instanceView.currentState.exitCode" \
              --output tsv)
            
            az container delete --name $MIG_JOB_NAME --resource-group $RG_NAME --yes

            if [ "$EXIT_CODE" -ne 0 ]; then
              echo "Migration FAILED with exit code $EXIT_CODE."
              exit 1
            fi
            echo "Migrations completed successfully inside Azure VNet."

      - name: Deploy to Azure Container App
        uses: azure/CLI@v1
        with:
          inlineScript: |
            TAG="${GITHUB_SHA::7}"
            
            az containerapp update \
              --name sd-synapse-4d-app \
              --resource-group sd-synapse-4d-rg \
              --image ${{ secrets.ACR_NAME }}.azurecr.io/synapse-backend:$TAG